using JosephsonCircuits
using SparseArrays
import AxisKeys
import AxisKeys.NamedDims
import AxisKeys.NamedDims: NamedDimsArray

using Test

@testset verbose=true "JosephsonCircuits" begin

    @testset verbose=true "warmup" begin
        @variables Ipump Rleft Cc Lj Cj w L1
        out1 = JosephsonCircuits.HB(JosephsonCircuits.NonlinearHB((2.9845193040956104e10,), JosephsonCircuits.Frequencies{1}((4,), (5,), (8,), CartesianIndex{1}[CartesianIndex(2,), CartesianIndex(4,)], [(1,), (3,)]), ComplexF64[-0.013189713633104415 - 0.008651147208075902im, 2.638535275923282e-5 - 5.730931597816842e-6im, 0.1215732825534514 + 0.07973637714135198im, 1.3583890694744758e-5 - 6.466918389420196e-5im], sparse([1, 2, 3, 4], [1, 2, 3, 4], [1, 1, 1, 1], 4, 4), sparsevec([2], ComplexF64[1.0e-9 + 0.0im], 2), sparsevec(Int64[], Nothing[], 2), sparsevec([3, 4], ComplexF64[1.0e-9 + 0.0im, 1.0e-9 + 0.0im], 4), 2, 2, ["0", "1", "2"], [1], [(1,), (3,)], ComplexF64[-0.39841720622718607 - 0.9171852686842763im 0.0 + 0.0im; 0.0006902518137312249 + 0.003177936656046736im 0.0 + 0.0im], Dict{Int64, NonlinearElement}(2 => NonlinearElement(:josephson, [2], Dict{Symbol, Any}(:inductance => 1.0e-9 + 0.0im, :Lj => 1.0e-9 + 0.0im)))), JosephsonCircuits.LinearizedHB(2.827433388230814e10:3.141592653589793e9:3.141592653589793e10, [(0,), (-2,)], ComplexF64[0.8793432544356948 - 0.47684762507575934im 0.020027766663629095 - 0.015070010763667895im; 0.024683119947305567 + 0.004354337104171506im 0.9999645263305277 + 0.026441685697268326im;;; 0.9999651737600814 - 0.02642091321769538im 0.024687073668703086 - 0.004354512827245334im; 0.020030593330902246 + 0.015072780735439363im 0.8793336998975008 + 0.47686545021930205im], Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), [0.999372571659925 0.0006274283400750089; 0.0006274283400750096 0.999372571659925;;; 0.9993723754270823 0.0006276245729177389; 0.0006276245729177399 0.9993723754270823], [0.9993725716599237 1.0; 1.0 0.9993725716599252;;; 0.9993723754270819 1.0; 1.0 0.9993723754270832], [1.0000000000000013 1.0000000000000002; -0.9999999999999998 -0.9999999999999989], ComplexF64[], ComplexF64[], ComplexF64[], ComplexF64[], ["0", "1", "2"], [2 2 2 3 3; 1 1 3 1 1], ["P1", "R1", "C1", "Lj1", "C2"], [:P, :R, :C, :Lj, :C], Dict("C1" => 3, "C2" => 5, "R1" => 2, "P1" => 1, "Lj1" => 4), String[], [1], [1], [2], Int64[], String[], Int64[], 2, 3, 2, 1, 1))
        out2 = JosephsonCircuits.warmup()
        @test JosephsonCircuits.compare(out1,out2)
    end

    @testset verbose=true "warmupsymsold" begin
        @variables Rleft Cc Lj Cj w L1
        out1 = JosephsonCircuits.HB(JosephsonCircuits.NonlinearHB((2.9845193040956104e10,), JosephsonCircuits.Frequencies{1}((4,), (5,), (8,), CartesianIndex{1}[CartesianIndex(2,), CartesianIndex(4,)], [(1,), (3,)]), ComplexF64[-0.013172681534610684 - 0.008620192636062916im, 3.387748361625234e-6 + 8.323112211964174e-6im, 0.12179774887406933 + 0.07965319542032537im, 2.1979490981712597e-5 + 7.557330877921427e-7im], sparse([1, 2, 3, 4], [1, 2, 3, 4], [1, 1, 1, 1], 4, 4), sparsevec([2], [1.0e-9], 2), sparsevec(Int64[], Nothing[], 2), sparsevec([3, 4], [1.0e-9, 1.0e-9], 4), 2, 2, ["1", "2"], [1], [(1,), (3,)], ComplexF64[-0.40056972281992537 - 0.9160008919595216im 0.0 + 0.0im; -0.0010024623749453425 + 0.0004080312966861444im 0.0 + 0.0im], Dict{Int64, NonlinearElement}()), JosephsonCircuits.LinearizedHB(2.827433388230814e10:3.141592653589793e9:3.141592653589793e10, [(-2,), (0,)], ComplexF64[0.9999636971626669 + 0.026577597828738225im 0.02477628090844662 + 0.004460970065009672im; 0.02006351652496798 - 0.01520590853015713im 0.8793137132801239 - 0.4769079135295369im;;; 0.8793041537769262 + 0.4769257467844526im 0.020066345817059426 + 0.015208700168466727im; 0.024780251022882213 - 0.004461160668153891im 0.9999643476849712 - 0.026556847595942im], Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), [0.9993670379479913 0.0006329620520087743; 0.0006329620520087737 0.9993670379479913;;; 0.9993668400044972 0.0006331599955029414; 0.0006331599955029414 0.9993668400044972], [0.9993670379479905 1.0; 1.0 0.9993670379479901;;; 0.9993668400044973 1.0; 1.0 0.9993668400044973], [-1.0000000000000009 -0.9999999999999999; 1.000000000000001 0.9999999999999999], ComplexF64[], ComplexF64[], ComplexF64[], ComplexF64[], ["0", "1", "2"], [2 2 2 3 3; 1 1 3 1 1], ["P1", "R1", "C1", "Lj1", "C2"], [:P, :R, :C, :Lj, :C], Dict("C1" => 3, "C2" => 5, "R1" => 2, "P1" => 1, "Lj1" => 4), String[], [1], [1], [2], Int64[], String[], Int64[], 2, 3, 2, 1, 2))
        out2 = JosephsonCircuits.warmupsymsold()
        @test JosephsonCircuits.compare(out1,out2)
    end

    @testset verbose=true "warmupsymsnew" begin
        @variables Rleft Cc Lj Cj w L1
        out1 = JosephsonCircuits.HB(JosephsonCircuits.NonlinearHB((2.9845193040956104e10,), JosephsonCircuits.Frequencies{1}((4,), (5,), (8,), CartesianIndex{1}[CartesianIndex(2,), CartesianIndex(4,)], [(1,), (3,)]), AxisKeys.KeyedArray{ComplexF64, 2, NamedDims.NamedDimsArray{(:outputmode, :node), ComplexF64, 2, Matrix{ComplexF64}}, Tuple{Vector{Tuple{Int64}}, Vector{String}}}(NamedDimsArray(ComplexF64[-0.013189713633104328 - 0.008651147208076224im 0.1215732825534493 + 0.07973637714135108im; 2.638535275923149e-5 - 5.730931597816161e-6im 1.358389069474495e-5 - 6.46691838941983e-5im], (:outputmode, :node)), ([(1,), (3,)], ["1", "2"])), sparse([1, 2, 3, 4], [1, 2, 3, 4], [1, 1, 1, 1], 4, 4), sparsevec([2], [1.0e-9], 2), sparsevec(Int64[], Nothing[], 2), sparsevec([3, 4], [1.0e-9, 1.0e-9], 4), 2, 2, ["0", "1", "2"], [1], [(1,), (3,)], AxisKeys.KeyedArray{ComplexF64, 4, NamedDims.NamedDimsArray{(:outputmode, :outputport, :inputmode, :inputport), ComplexF64, 4, Array{ComplexF64, 4}}, Tuple{Vector{Tuple{Int64}}, Vector{Int64}, Vector{Tuple{Int64}}, Vector{Int64}}}(NamedDimsArray([-0.3984172062271636 - 0.9171852686842704im; 0.0006902518137311428 + 0.0031779366560465757im;;; 0.0 + 0.0im; 0.0 + 0.0im;;;;], (:outputmode, :outputport, :inputmode, :inputport)), ([(1,), (3,)], [1], [(1,), (3,)], [1])), Dict{Int64, NonlinearElement}(2 => NonlinearElement(:josephson, [2], Dict{Symbol, Any}(:inductance => 1.0e-9, :Lj => 1.0e-9)))), JosephsonCircuits.LinearizedHB(2.827433388230814e10:3.141592653589793e9:3.141592653589793e10, [(0,), (2,), (-2,)], AxisKeys.KeyedArray{ComplexF64, 5, NamedDims.NamedDimsArray{(:outputmode, :outputport, :inputmode, :inputport, :freqindex), ComplexF64, 5, Array{ComplexF64, 5}}, Tuple{Vector{Tuple{Int64}}, Vector{Int64}, Vector{Tuple{Int64}}, Vector{Int64}, UnitRange{Int64}}}(NamedDimsArray([0.8793569504109443 - 0.47681967169273876im; -0.0007934007343287591 + 0.0013286644026411442im; 0.024679629873200038 + 0.0043538778518115665im;;; 0.001512328226489033 - 0.00032760895856871557im; 0.7304798277512885 - 0.6829325423534629im; -6.37823775245524e-5 + 0.00016295097095725243im;;; 0.020025158424520146 - 0.015067615722927218im; -0.0001705218151428818 - 4.3738391467828484e-5im; 0.9999644639585391 + 0.026441290141526786im;;;;; 0.9999647914129438 - 0.02638429641209193im; 0.0011629933572913824 - 0.0012285222260809im; 0.020032903114943077 + 0.01507513767399213im;;; -0.0016915420142723293 - 1.2595516192949867e-5im; 0.7132140455028935 - 0.7009442824244202im; -0.00010855760658972386 + 0.00010702508091378949im;;; 0.024690396695749902 - 0.004354416922277141im; -0.00010956779790372759 - 0.00010761689252906938im; 0.8793339176946257 + 0.47686524450209766im], (:outputmode, :outputport, :inputmode, :inputport, :freqindex)), ([(0,), (2,), (-2,)], [1], [(0,), (2,), (-2,)], [1], 1:2)), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), AxisKeys.KeyedArray{Float64, 5, NamedDims.NamedDimsArray{(:outputmode, :outputport, :inputmode, :inputport, :freqindex), Float64, 5, Array{Float64, 5}}, Tuple{Vector{Tuple{Int64}}, Vector{Int64}, Vector{Tuple{Int64}}, Vector{Int64}, UnitRange{Int64}}}(NamedDimsArray([0.9993703564049484; 2.394833671643844e-6; 0.000627252464855619;;; 2.391460428690098e-6; 0.9999975741755938; 3.0582794285956745e-8;;; 0.0006272521346227394; 3.09907344069648e-8; 0.9993727169523501;;;;; 0.9993693547090311; 2.861820274078016e-6; 0.0006277877280917366;;; 2.857880239584042e-6; 0.9999971145932292; 2.320994234326287e-8;;; 0.0006277874107293358; 2.358649678243965e-8; 0.9993721890619659], (:outputmode, :outputport, :inputmode, :inputport, :freqindex)), ([(0,), (2,), (-2,)], [1], [(0,), (2,), (-2,)], [1], 1:2)), AxisKeys.KeyedArray{Float64, 5, NamedDims.NamedDimsArray{(:outputmode, :outputport, :inputmode, :inputport, :freqindex), Float64, 5, Array{Float64, 5}}, Tuple{Vector{Tuple{Int64}}, Vector{Int64}, Vector{Tuple{Int64}}, Vector{Int64}, UnitRange{Int64}}}(NamedDimsArray([0.9993751363371318; 1.0; 1.0;;; 1.0; 1.0; 1.0;;; 1.0; 1.0; 0.9993727169523507;;;;; 0.9993750668975425; 1.0; 1.0;;; 1.0; 1.0; 1.0;;; 1.0; 1.0; 0.9993721890619665], (:outputmode, :outputport, :inputmode, :inputport, :freqindex)), ([(0,), (2,), (-2,)], [1], [(0,), (2,), (-2,)], [1], 1:2)), AxisKeys.KeyedArray{Float64, 3, NamedDims.NamedDimsArray{(:outputmode, :outputport, :freqindex), Float64, 3, Array{Float64, 3}}, Tuple{Vector{Tuple{Int64}}, Vector{Int64}, UnitRange{Int64}}}(NamedDimsArray([1.0000000000000004; 1.0000000000000002; -0.9999999999999996;;; 1.0; 1.0; -0.9999999999999996], (:outputmode, :outputport, :freqindex)), ([(0,), (2,), (-2,)], [1], 1:2)), ComplexF64[], ComplexF64[], ComplexF64[], ComplexF64[], ["0", "1", "2"], [2 2 2 3 3; 1 1 3 1 1], ["P1", "R1", "C1", "Lj1", "C2"], [:P, :R, :C, :Lj, :C], Dict("C1" => 3, "C2" => 5, "R1" => 2, "P1" => 1, "Lj1" => 4), String[], [1], [1], [2], Int64[], String[], Int64[], 3, 3, 2, 1, 1))
        out2 = JosephsonCircuits.warmupsymsnew()
        @test JosephsonCircuits.compare(out1,out2)
    end

    @testset verbose=true "warmupsyms" begin
        @variables Rleft Cc Lj Cj w L1
        out1 = JosephsonCircuits.HB(JosephsonCircuits.NonlinearHB((2.9845193040956104e10,), JosephsonCircuits.Frequencies{1}((4,), (5,), (8,), CartesianIndex{1}[CartesianIndex(2,), CartesianIndex(4,)], [(1,), (3,)]), ComplexF64[-0.013189713633104415 - 0.008651147208075902im, 2.638535275923282e-5 - 5.730931597816842e-6im, 0.1215732825534514 + 0.07973637714135198im, 1.3583890694744758e-5 - 6.466918389420196e-5im], sparse([1, 2, 3, 4], [1, 2, 3, 4], [1, 1, 1, 1], 4, 4), sparsevec([2], [1.0e-9], 2), sparsevec(Int64[], Nothing[], 2), sparsevec([3, 4], [1.0e-9, 1.0e-9], 4), 2, 2, ["0", "1", "2"], [1], [(1,), (3,)], ComplexF64[-0.39841720622718607 - 0.9171852686842763im 0.0 + 0.0im; 0.0006902518137312249 + 0.003177936656046736im 0.0 + 0.0im], Dict{Int64, NonlinearElement}(2 => NonlinearElement(:josephson, [2], Dict{Symbol, Any}(:inductance => 1.0e-9, :Lj => 1.0e-9)))), JosephsonCircuits.LinearizedHB(2.827433388230814e10:3.141592653589793e9:3.141592653589793e10, [(0,), (-2,)], ComplexF64[0.8793432544356948 - 0.47684762507575934im 0.020027766663629095 - 0.015070010763667895im; 0.024683119947305567 + 0.004354337104171506im 0.9999645263305277 + 0.026441685697268326im;;; 0.9999651737600814 - 0.02642091321769538im 0.024687073668703086 - 0.004354512827245334im; 0.020030593330902246 + 0.015072780735439363im 0.8793336998975008 + 0.47686545021930205im], Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), [0.999372571659925 0.0006274283400750089; 0.0006274283400750096 0.999372571659925;;; 0.9993723754270823 0.0006276245729177389; 0.0006276245729177399 0.9993723754270823], [0.9993725716599237 1.0; 1.0 0.9993725716599252;;; 0.9993723754270819 1.0; 1.0 0.9993723754270832], [1.0000000000000013 1.0000000000000002; -0.9999999999999998 -0.9999999999999989], ComplexF64[], ComplexF64[], ComplexF64[], ComplexF64[], ["0", "1", "2"], [2 2 2 3 3; 1 1 3 1 1], ["P1", "R1", "C1", "Lj1", "C2"], [:P, :R, :C, :Lj, :C], Dict("C1" => 3, "C2" => 5, "R1" => 2, "P1" => 1, "Lj1" => 4), String[], [1], [1], [2], Int64[], String[], Int64[], 2, 3, 2, 1, 1))
        out2 = JosephsonCircuits.warmupsyms()
        @test JosephsonCircuits.compare(out1,out2)
    end

    @testset verbose=true "warmupparse" begin
        @variables Ipump Rleft Cc Lj Cj w L1
        out1 = JosephsonCircuits.ParsedCircuit([1, 2, 1, 2, 1, 3, 3, 2, 3, 2], ["1", "0", "2"], String[], ["P1", "R1", "C1", "Lj1", "C2"], [:P, :R, :C, :Lj, :C], Num[1, Rleft, Cc, Lj, Cj], Dict("C1" => 3, "C2" => 5, "R1" => 2, "P1" => 1, "Lj1" => 4), 3)
        out2 = JosephsonCircuits.warmupparse()
        @test JosephsonCircuits.compare(out1,out2)
    end

    @testset verbose=true "warmupparsesort" begin
        @variables Ipump Rleft Cc Lj Cj w L1
        out1 = JosephsonCircuits.ParsedSortedCircuit([2 2 2 3 3; 1 1 3 1 1], ["0", "1", "2"], String[], ["P1", "R1", "C1", "Lj1", "C2"], [:P, :R, :C, :Lj, :C], Num[1, Rleft, Cc, Lj, Cj], Dict("C1" => 3, "C2" => 5, "R1" => 2, "P1" => 1, "Lj1" => 4), 3)
        out2 = JosephsonCircuits.warmupparsesort()
        @test JosephsonCircuits.compare(out1,out2)
    end

    @testset verbose=true "warmupnumericmatrices" begin
        out1 = JosephsonCircuits.CircuitMatrices(sparse([1, 2, 1, 2], [1, 1, 2, 2], [1.0e-13, -1.0e-13, -1.0e-13, 1.1e-12], 2, 2), sparse([1], [1], [0.02], 2, 2), sparsevec(Int64[], Nothing[], 2), sparsevec(Int64[], Nothing[], 2), sparsevec([2], [1.0e-9], 2), sparsevec([2], [1.0e-9], 2), sparse(Int64[], Int64[], Nothing[], 2, 2), sparse(Int64[], Int64[], Nothing[], 2, 2), sparse([1, 2], [1, 2], [1, 1], 2, 2), [1], [1], [2], Int64[], 1.0e-9, Real[1, 50.0, 1.0e-13, 1.0e-9, 1.0e-12])
        out2 = JosephsonCircuits.warmupnumericmatrices()
        @test JosephsonCircuits.compare(out1,out2)

    end

    @testset verbose=true "warmuphblinsolve" begin
        out1 = JosephsonCircuits.LinearizedHB(2.827433388230814e10:6.283185307179586e8:3.141592653589793e10, [(0,)], AxisKeys.KeyedArray{ComplexF64, 5, NamedDims.NamedDimsArray{(:outputmode, :outputport, :inputmode, :inputport, :freqindex), ComplexF64, 5, Array{ComplexF64, 5}}, Tuple{Vector{Tuple{Int64}}, Vector{Int64}, Vector{Tuple{Int64}}, Vector{Int64}, UnitRange{Int64}}}(NamedDimsArray([0.8952708641229391 - 0.44552225517090227im;;;;; 0.8415115570832487 - 0.5402391130743189im;;;;; 0.6457820691998714 - 0.7635217869189669im;;;;; -0.9968560060568034 + 0.07923448231975308im;;;;; 0.9316787544566122 + 0.36328322077158454im;;;;; 0.9988570509555925 + 0.04779740323801577im], (:outputmode, :outputport, :inputmode, :inputport, :freqindex)), ([(0,)], [1], [(0,)], [1], 1:6)), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), Array{ComplexF64, 3}(undef, 0, 0, 0), AxisKeys.KeyedArray{Float64, 5, NamedDims.NamedDimsArray{(:outputmode, :outputport, :inputmode, :inputport, :freqindex), Float64, 5, Array{Float64, 5}}, Tuple{Vector{Tuple{Int64}}, Vector{Int64}, Vector{Tuple{Int64}}, Vector{Int64}, UnitRange{Int64}}}(NamedDimsArray([1.0;;;;; 1.0;;;;; 1.0;;;;; 1.0;;;;; 1.0;;;;; 1.0], (:outputmode, :outputport, :inputmode, :inputport, :freqindex)), ([(0,)], [1], [(0,)], [1], 1:6)), AxisKeys.KeyedArray{Float64, 5, NamedDims.NamedDimsArray{(:outputmode, :outputport, :inputmode, :inputport, :freqindex), Float64, 5, Array{Float64, 5}}, Tuple{Vector{Tuple{Int64}}, Vector{Int64}, Vector{Tuple{Int64}}, Vector{Int64}, UnitRange{Int64}}}(NamedDimsArray([0.9999999999999993;;;;; 0.9999999999999996;;;;; 1.0;;;;; 0.9999999999999991;;;;; 1.0;;;;; 0.9999999999999993], (:outputmode, :outputport, :inputmode, :inputport, :freqindex)), ([(0,)], [1], [(0,)], [1], 1:6)), AxisKeys.KeyedArray{Float64, 3, NamedDims.NamedDimsArray{(:outputmode, :outputport, :freqindex), Float64, 3, Array{Float64, 3}}, Tuple{Vector{Tuple{Int64}}, Vector{Int64}, UnitRange{Int64}}}(NamedDimsArray([1.0000000000000007;;; 1.0000000000000004;;; 0.9999999999999997;;; 1.0000000000000009;;; 1.0;;; 1.0000000000000007], (:outputmode, :outputport, :freqindex)), ([(0,)], [1], 1:6)), ComplexF64[], ComplexF64[], ComplexF64[], ComplexF64[], ["0", "1", "2"], [2 2 2 3 3; 1 1 3 1 1], ["P1", "R1", "C1", "Lj1", "C2"], [:P, :R, :C, :Lj, :C], Dict("C1" => 3, "C2" => 5, "R1" => 2, "P1" => 1, "Lj1" => 4), String[], [1], [1], [2], Int64[], String[], Int64[], 1, 3, 2, 1, 1)
        out2 = JosephsonCircuits.warmuphblinsolve()
        @test JosephsonCircuits.compare(out1,out2)
    end

    @testset verbose=true "warmupvvn" begin
        out1 = Real[1, 50.0, 1.0e-13, 1.0e-9, 1.0e-12]
        out2 = JosephsonCircuits.warmupvvn()
        @test JosephsonCircuits.compare(out1,out2)
    end

    @testset verbose=true "warmupnetwork" begin
        @test JosephsonCircuits.warmupnetwork()
    end

    @testset verbose=true "warmupconnect" begin
        @test JosephsonCircuits.warmupconnect()
    end

end